<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Study - Retrospective Labeling</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
        }
        .video-section {
            max-width: 900px;
            margin: 0 auto;
        }
        .selectable-word {
            display: inline;
            padding: 3px 4px;
            margin: 0;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
            font-size: 16px;
        }
        .selectable-word:hover {
            background-color: #f0f0f0;
        }
        .selectable-word.highlighted {
            background-color: #fff9e6;
        }
        .selectable-word.highlighted:hover {
            background-color: #ffe082;
        }
        .selectable-word.selected {
            background-color: #2196f3;
            color: white;
        }
        .context-word {
            display: inline;
            padding: 2px 3px;
            margin: 0;
            color: #999;
            font-size: 14px;
        }
        .progress {
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }
        .video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px;
            padding-bottom: 450px;
        }
        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .gesture-info {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }
        .gesture-info strong {
            color: #856404;
        }
        .instruction {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        .question {
            margin-bottom: 25px;
        }
        .question-label {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 16px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
            box-sizing: border-box;
        }
        .submit-btn {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }
        .submit-btn:hover {
            background-color: #45a049;
        }
        .complete-message {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }
        .replay-btn {
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 14px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .replay-btn:hover {
            background-color: #1976d2;
        }
        .time-controls {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .time-btn {
            padding: 8px 12px;
            font-size: 13px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
            max-width: 120px;
        }
        .time-btn:hover {
            background-color: #45a049;
        }
        .time-btn.center {
            background-color: #ff9800;
        }
        .time-btn.center:hover {
            background-color: #f57c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="progress" id="progressIndicator"></div>

        <div id="labelingForm">
            <div class="instruction">
                Watch the ±10 second clip around when you pressed spacebar.
                Then select the word(s) you were targeting and describe what you wanted to know.
            </div>

            <div class="gesture-info" id="gestureInfo"></div>

            <div class="video-section">
                <div class="video-container">
                    <div id="player"></div>
                </div>
                <div class="time-controls">
                    <button class="time-btn" onclick="jumpToTime('start')">← Start (-10s)</button>
                    <button class="time-btn center" onclick="jumpToTime('gesture')">◉ Gesture (0s)</button>
                    <button class="time-btn" onclick="jumpToTime('end')">End (+10s) →</button>
                </div>
            </div>

            <form id="gestureForm">
                <div class="question">
                    <div class="question-label">1. What word or phrase were you targeting at this moment?</div>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 12px;">
                            <input type="radio" name="target_source" value="transcript" id="targetFromTranscript" style="margin-right: 8px;" checked>
                            Specific word/phrase in the transcript (click a word below)
                        </label>

                        <div id="wordSelectionArea" style="margin-left: 28px; margin-bottom: 12px; padding: 20px; border: 1px solid #ddd; border-radius: 4px; background-color: #fafafa; min-height: 200px; max-height: 400px; overflow-y: auto;">
                            <div id="clickableWords" style="line-height: 2.5; font-size: 16px;">
                                Loading words...
                            </div>
                        </div>

                        <input type="hidden" id="targetWordTranscript" name="target_word_transcript" required>
                        <div id="selectedWordDisplay" style="margin-left: 28px; margin-bottom: 12px; padding: 8px; background-color: #e3f2fd; border-radius: 4px; display: none;">
                            Selected: <strong id="selectedWordText"></strong>
                        </div>

                        <label style="display: block; margin-bottom: 12px;">
                            <input type="radio" name="target_source" value="other" id="targetOther" style="margin-right: 8px;">
                            Other
                        </label>
                        <textarea
                            id="targetWordOther"
                            name="target_word_other"
                            rows="2"
                            disabled
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-left: 28px; background-color: #f5f5f5;"
                            placeholder="Please specify..."></textarea>
                    </div>
                </div>

                <div class="question">
                    <div class="question-label">2. What did you want to know about it? (select all that apply)</div>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" name="intent" value="lookup_meaning" style="margin-right: 8px;">
                            Look up the meaning of a word or phrase
                        </label>
                        <label style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" name="intent" value="background_info" style="margin-right: 8px;">
                            Retrieve general background information about a concept
                        </label>
                        <label style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" name="intent" value="find_images" style="margin-right: 8px;">
                            Find related images
                        </label>
                        <label style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" name="intent" value="other" id="intentOther" style="margin-right: 8px;">
                            Others:
                        </label>
                        <textarea
                            id="intentOtherText"
                            name="intent_other_text"
                            rows="2"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; display: none;"
                            placeholder="Please specify..."></textarea>
                    </div>
                    <div id="intentError" style="color: #d32f2f; font-size: 14px; margin-top: 8px; display: none;">
                        Please select at least one option
                    </div>
                </div>

                <button type="submit" class="submit-btn">Submit & Next</button>
                <div style="clear: both;"></div>
            </form>
        </div>

        <div id="completeMessage" style="display: none;" class="complete-message">
            All gestures have been labeled. Thank you for participating!
            <br><br>
            <p style="color: #666; font-size: 14px;">
                Your data has been saved on the server.
            </p>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const API_URL = window.location.origin;
        const sessionId = sessionStorage.getItem('study_session_id');

        let gestures = [];
        let videos = [];
        let currentVideoIndex = 0;
        let currentGestureIndex = 0;
        let player = null;
        let currentClipStart = 0;
        let currentClipEnd = 0;
        let currentGestureTime = 0;
        let selectedWordTimestamp = null;
        let selectedWords = []; // Array to store multiple selected words
        let isTutorial = false;

        // Check if this is tutorial mode
        const params = new URLSearchParams(window.location.search);
        isTutorial = params.get('tutorial') === 'true';

        // Toggle text fields based on radio/checkbox selection
        document.addEventListener('DOMContentLoaded', function() {
            // Question 1: Toggle between transcript and other
            const transcriptRadio = document.getElementById('targetFromTranscript');
            const otherRadio = document.getElementById('targetOther');
            const transcriptText = document.getElementById('targetWordTranscript');
            const otherText = document.getElementById('targetWordOther');

            function toggleTargetFields() {
                if (transcriptRadio.checked) {
                    transcriptText.disabled = false;
                    transcriptText.required = true;
                    transcriptText.style.backgroundColor = 'white';
                    otherText.disabled = true;
                    otherText.required = false;
                    otherText.style.backgroundColor = '#f5f5f5';
                } else {
                    transcriptText.disabled = true;
                    transcriptText.required = false;
                    transcriptText.style.backgroundColor = '#f5f5f5';
                    otherText.disabled = false;
                    otherText.required = true;
                    otherText.style.backgroundColor = 'white';
                }
            }

            if (transcriptRadio && otherRadio) {
                transcriptRadio.addEventListener('change', toggleTargetFields);
                otherRadio.addEventListener('change', toggleTargetFields);
                toggleTargetFields(); // Initialize
            }

            // Question 2: Toggle "Other" text field
            const intentOtherCheckbox = document.getElementById('intentOther');
            const intentOtherText = document.getElementById('intentOtherText');

            if (intentOtherCheckbox) {
                intentOtherCheckbox.addEventListener('change', function() {
                    intentOtherText.style.display = this.checked ? 'block' : 'none';
                });
            }
        });

        // Get video index from URL parameter
        function getVideoIndexFromURL() {
            const params = new URLSearchParams(window.location.search);
            const videoParam = params.get('video');
            return videoParam ? parseInt(videoParam) : 0;
        }

        async function loadVideos() {
            const response = await fetch(`${API_URL}/api/youtube/videos`);
            const data = await response.json();
            videos = data.videos;
        }

        async function loadGestures() {
            const response = await fetch(`${API_URL}/api/gestures/get/${sessionId}`);
            const data = await response.json();

            // Filter gestures based on tutorial mode
            if (isTutorial) {
                gestures = data.gestures.filter(g => g.is_tutorial === true);
                currentVideoIndex = -1; // Tutorial uses -1
            } else {
                currentVideoIndex = getVideoIndexFromURL();
                gestures = data.gestures.filter(g => g.video_index === currentVideoIndex);
            }

            // Load videos first
            await loadVideos();

            // If no gestures, proceed
            if (gestures.length === 0) {
                document.getElementById('labelingForm').style.display = 'none';
                document.getElementById('completeMessage').style.display = 'block';
                if (isTutorial) {
                    document.getElementById('completeMessage').innerHTML = `
                        <h2>No spacebar presses in tutorial</h2>
                        <p>Please try again. Press spacebar at least once during the tutorial video.</p>
                        <button onclick="window.location.href='/youtube?tutorial=true'" style="margin-top: 20px; padding: 12px 24px; font-size: 16px; background-color: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry Tutorial</button>
                    `;
                } else {
                    document.getElementById('completeMessage').innerHTML = `
                        <h2>No spacebar presses for Video ${currentVideoIndex + 1}</h2>
                        <p>Proceeding to next video...</p>
                    `;
                    setTimeout(() => {
                        proceedToNextVideo();
                    }, 2000);
                }
            } else {
                displayGesture(0);
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '450',
                width: '800',
                playerVars: {
                    autoplay: 1,
                    controls: 1,
                    modestbranding: 1,
                    rel: 0,
                    cc_load_policy: 1  // Enable captions by default
                },
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady(event) {
            console.log('Player ready');
            loadGestures();
        }

        function displayGesture(index) {
            if (index >= gestures.length) {
                // Finished labeling all gestures for this video
                document.getElementById('labelingForm').style.display = 'none';
                document.getElementById('completeMessage').style.display = 'block';
                proceedToNextVideo();
                return;
            }

            currentGestureIndex = index;
            const gesture = gestures[index];
            const gestureTime = gesture.video_time;
            const videoIndex = gesture.is_tutorial ? 0 : gesture.video_index;
            const video = videos[videoIndex];

            if (isTutorial) {
                document.getElementById('progressIndicator').textContent =
                    `Tutorial - Practice Gesture ${index + 1} of ${gestures.length}`;
            } else {
                document.getElementById('progressIndicator').textContent =
                    `Video ${currentVideoIndex + 1} - Gesture ${index + 1} of ${gestures.length}`;
            }

            // Calculate clip boundaries (±10 seconds, but respect video boundaries)
            const clipStart = Math.max(video.start_time, gestureTime - 10);
            const clipEnd = Math.min(video.end_time, gestureTime + 10);

            // Store current clip info for time navigation
            currentClipStart = clipStart;
            currentClipEnd = clipEnd;
            currentGestureTime = gestureTime;

            document.getElementById('gestureInfo').innerHTML = `
                <strong>Video:</strong> ${video.title}<br>
                <strong>You pressed spacebar at:</strong> ${formatTime(gestureTime)}<br>
                <strong>Showing clip:</strong> ${formatTime(clipStart)} to ${formatTime(clipEnd)} (centered on your press)
            `;

            // Load and play the clip (allow full video range)
            player.loadVideoById({
                videoId: video.video_id,
                startSeconds: clipStart,
                endSeconds: video.end_time
            });

            // Load transcript for this clip
            loadTranscript(clipStart, clipEnd);

            // Reset form and set defaults
            document.getElementById('gestureForm').reset();
            document.getElementById('targetFromTranscript').checked = true;
            document.getElementById('targetWordTranscript').disabled = false;
            document.getElementById('targetWordTranscript').required = true;
            document.getElementById('targetWordTranscript').style.backgroundColor = 'white';
            document.getElementById('targetWordOther').disabled = true;
            document.getElementById('targetWordOther').required = false;
            document.getElementById('targetWordOther').style.backgroundColor = '#f5f5f5';
            document.getElementById('intentOtherText').style.display = 'none';
            document.getElementById('selectedWordDisplay').style.display = 'none';

            // Reset selected words
            selectedWords = [];
            selectedWordTimestamp = null;

            document.getElementById('targetWordTranscript').focus();
        }

        async function loadTranscript(startTime, endTime) {
            try {
                const gesture = gestures[currentGestureIndex];
                const video = videos[gesture.video_index];

                // Load wider range for scrolling (±60 seconds from gesture time)
                const expandedStart = Math.max(video.start_time, currentGestureTime - 60);
                const expandedEnd = Math.min(video.end_time, currentGestureTime + 60);

                // Fetch transcript for wider range
                const response = await fetch(
                    `${API_URL}/api/transcript/get?video_id=${video.video_id}&start=${expandedStart}&end=${expandedEnd}`
                );

                if (!response.ok) {
                    throw new Error('Transcript not found');
                }

                const data = await response.json();

                if (data.segments && data.segments.length > 0) {
                    displayTranscriptSegments(data.segments, startTime, endTime);
                } else {
                    document.getElementById('transcriptContent').innerHTML = `
                        <p style="color: #666; font-style: italic;">
                            No transcript available for this time segment.
                        </p>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">
                            Note: You can enable YouTube captions by clicking the CC button on the video player.
                        </p>
                    `;
                }
            } catch (error) {
                console.error('Error loading transcript:', error);
                document.getElementById('transcriptContent').innerHTML = `
                    <p style="color: #666; font-style: italic;">
                        Transcript not available for this video.
                    </p>
                    <p style="color: #999; font-size: 12px; margin-top: 10px;">
                        Note: You can enable YouTube captions by clicking the CC button on the video player.
                    </p>
                `;
            }
        }

        function displayTranscriptSegments(segments, highlightStart, highlightEnd) {
            let clickableWordsHtml = '';
            let firstHighlightedWordId = null;

            segments.forEach(seg => {
                // Process words for Question 1 area
                if (seg.words && seg.words.length > 0) {
                    seg.words.forEach((word, idx) => {
                        const cleanWord = word.word.trim();
                        const wordId = `select-${seg.start}-${idx}`;
                        const isInHighlightRange = word.start >= highlightStart && word.start <= highlightEnd;

                        if (isInHighlightRange) {
                            // Words in ±10s range: highlighted and clickable
                            if (!firstHighlightedWordId) {
                                firstHighlightedWordId = wordId;
                            }
                            clickableWordsHtml += `<span class="selectable-word highlighted" id="${wordId}"
                                                    data-word="${cleanWord}"
                                                    data-time="${word.start}"
                                                    onclick="selectWordFromQuestion('${wordId}', '${cleanWord.replace(/'/g, "\\'")}', ${word.start})">${word.word}</span>`;
                        } else {
                            // Words outside ±10s range: clickable but not highlighted
                            clickableWordsHtml += `<span class="selectable-word" id="${wordId}"
                                                    data-word="${cleanWord}"
                                                    data-time="${word.start}"
                                                    onclick="selectWordFromQuestion('${wordId}', '${cleanWord.replace(/'/g, "\\'")}', ${word.start})">${word.word}</span>`;
                        }
                    });
                }
            });

            // Display clickable words in Question 1 area
            document.getElementById('clickableWords').innerHTML = clickableWordsHtml || '<p style="color: #999; font-size: 13px; margin: 0;">No words available</p>';

            // Auto-scroll to highlighted words in Question 1 area
            if (firstHighlightedWordId) {
                setTimeout(() => {
                    const wordElement = document.getElementById(firstHighlightedWordId);
                    if (wordElement) {
                        wordElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
        }

        function selectWordFromQuestion(wordId, word, time) {
            const element = document.getElementById(wordId);
            if (!element) return;

            // Toggle selection
            const isCurrentlySelected = element.classList.contains('selected');

            if (isCurrentlySelected) {
                // Deselect this word
                element.classList.remove('selected');
                selectedWords = selectedWords.filter(w => w.id !== wordId);
            } else {
                // Select this word
                element.classList.add('selected');
                selectedWords.push({
                    id: wordId,
                    word: word,
                    time: time
                });
            }

            // Sort selected words by time to maintain order
            selectedWords.sort((a, b) => a.time - b.time);

            // Update form with combined phrase
            const transcriptRadio = document.getElementById('targetFromTranscript');
            const transcriptInput = document.getElementById('targetWordTranscript');
            const selectedWordDisplay = document.getElementById('selectedWordDisplay');
            const selectedWordText = document.getElementById('selectedWordText');

            if (selectedWords.length > 0) {
                // Combine selected words into a phrase
                const phrase = selectedWords.map(w => w.word).join(' ');

                // Use the timestamp of the first selected word
                selectedWordTimestamp = selectedWords[0].time;

                if (transcriptRadio && transcriptInput) {
                    transcriptRadio.checked = true;
                    transcriptInput.value = phrase;
                    transcriptInput.disabled = false;
                    transcriptInput.required = true;

                    // Show selected word display
                    if (selectedWordDisplay && selectedWordText) {
                        selectedWordText.textContent = phrase;
                        selectedWordDisplay.style.display = 'block';
                    }

                    // Disable other input
                    const otherInput = document.getElementById('targetWordOther');
                    if (otherInput) {
                        otherInput.disabled = true;
                        otherInput.required = false;
                        otherInput.style.backgroundColor = '#f5f5f5';
                    }
                }

                // Jump to the first selected word's time
                if (player) {
                    player.seekTo(selectedWords[0].time);
                }
            } else {
                // No words selected, clear the form
                selectedWordTimestamp = null;
                if (transcriptInput) {
                    transcriptInput.value = '';
                }
                if (selectedWordDisplay) {
                    selectedWordDisplay.style.display = 'none';
                }
            }

            console.log(`Selected words: ${selectedWords.map(w => w.word).join(' ')}`);
        }

        function replayClip() {
            player.seekTo(currentClipStart);
            player.playVideo();
        }

        function jumpToTime(position) {
            let targetTime;

            switch(position) {
                case 'start':
                    targetTime = currentClipStart;
                    break;
                case 'gesture':
                    targetTime = currentGestureTime;
                    break;
                case 'end':
                    targetTime = currentClipEnd;
                    break;
                default:
                    targetTime = currentGestureTime;
            }

            player.seekTo(targetTime);
            player.playVideo();
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        document.getElementById('gestureForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const gesture = gestures[currentGestureIndex];
            const formData = new FormData(e.target);

            // Question 1: Get target word based on selected source
            const targetSource = formData.get('target_source');
            let targetWord = '';
            if (targetSource === 'transcript') {
                targetWord = formData.get('target_word_transcript');
            } else {
                targetWord = formData.get('target_word_other');
            }

            // Question 2: Collect all checked intent values
            const intents = [];
            const intentCheckboxes = document.querySelectorAll('input[name="intent"]:checked');
            intentCheckboxes.forEach(cb => {
                intents.push(cb.value);
            });

            // Validate: at least one intent must be selected
            const intentError = document.getElementById('intentError');
            if (intents.length === 0) {
                intentError.style.display = 'block';
                intentError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            intentError.style.display = 'none';

            const labelData = {
                session_id: sessionId,
                gesture_timestamp: gesture.gesture_timestamp,
                video_time: gesture.video_time,
                video_id: gesture.video_id,
                video_index: gesture.video_index,
                is_tutorial: isTutorial,
                target_source: targetSource,
                target_word: targetWord,
                target_word_timestamp: selectedWordTimestamp,
                pressed_timestamp: gesture.video_time,
                intent_types: intents,
                intent_other_text: formData.get('intent_other_text') || ''
            };

            await fetch(`${API_URL}/api/label/submit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(labelData)
            });

            // Reset for next gesture
            selectedWords = [];
            selectedWordTimestamp = null;
            currentGestureIndex++;
            displayGesture(currentGestureIndex);
        });

        async function proceedToNextVideo() {
            if (isTutorial) {
                // Tutorial complete, start actual study from video 0
                document.getElementById('completeMessage').innerHTML = `
                    <h2>Tutorial Complete!</h2>
                    <p>Great! Now you're ready to start the actual study.</p>
                    <p>Redirecting to first video...</p>
                `;
                setTimeout(() => {
                    window.location.href = `/youtube?video=0`;
                }, 2000);
                return;
            }

            const nextVideoIndex = currentVideoIndex + 1;

            // Check if there are more videos
            if (nextVideoIndex < videos.length) {
                // Update message and redirect to next video
                document.getElementById('completeMessage').innerHTML = `
                    <h2>Labeling Complete for Video ${currentVideoIndex + 1}!</h2>
                    <p>Redirecting to next video...</p>
                `;
                setTimeout(() => {
                    window.location.href = `/youtube?video=${nextVideoIndex}`;
                }, 2000);
            } else {
                // All videos completed - mark session as complete
                await fetch(`${API_URL}/api/session/complete/${sessionId}`, {
                    method: 'POST'
                });
                document.getElementById('completeMessage').innerHTML = `
                    <h2>All Videos and Labeling Complete!</h2>
                    <p>Thank you for participating!</p>
                    <p style="color: #666; font-size: 14px;">Your data has been saved on the server.</p>
                `;
            }
        }
    </script>
</body>
</html>
